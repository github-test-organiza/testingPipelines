name: Run custom Specific Playwright Tests
on:
  workflow_dispatch:
    inputs:
      testFile:
        description: "Test file to run"
        required: true
        type: choice
        options:
          - tests/vineportal/smoke.tests.spec.js
          - tests/vineportal/admin.tests.spec.js
          - tests/vineportal/flows.tests.spec.js
          - tests/vineportal/massCommunications.tests.spec.js
          - tests/vineportal/projectForms.tests.spec.js
          - tests/vineportal/logInPortal.tests.spec.js
      grep:
        description: "Filter tests by name using --grep (optional)"
        required: false
      baseUrl:
        description: "Base URL to test against"
        required: false
      givenUsername:
        description: "Username for login"
        required: false
      givenPassword:
        description: "Password for login"
        required: false
      givenFilevineUsername:
        description: "Username for Filevine login"
        required: false
      givenFilevinePassword:
        description: "Password for Filevine login"
        required: false
jobs:
  debug-inputs:
    runs-on: ubuntu-latest
    name: Debug received inputs
    steps:
      - name: Show received inputs
        run: |
          echo "üîç testFile: ${{ github.event.inputs.testFile }}"
          echo "üîç grep: ${{ github.event.inputs.grep }}"
          echo "üîç baseUrl: ${{ github.event.inputs.baseUrl }}"
          echo "üîç givenUsername: ${{ github.event.inputs.givenUsername }}"
          echo "üîç givenPassword: ${{ github.event.inputs.givenPassword }}"
          echo "üîç givenFilevineUsername: ${{ github.event.inputs.givenFilevineUsername }}"
          echo "üîç givenFilevinePassword: ${{ github.event.inputs.givenFilevinePassword }}"
  run-playwright-tests:
    runs-on: ubuntu-latest
    needs: debug-inputs
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm ci
      - name: Install browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        env:
          GIVEN_BASE_URL_PORTAL: ${{ github.event.inputs.baseUrl }}
          GIVENUSERNAME: ${{ github.event.inputs.givenUsername }}
          GIVENPASSWORD: ${{ github.event.inputs.givenPassword }}
          GIVENFILEVINEUSERNAME: ${{ github.event.inputs.givenFilevineUsername }}
          GIVENFILEVINEPASSWORD: ${{ github.event.inputs.givenFilevinePassword }}
        run: |
          if [[ "${{ github.event.inputs.grep }}" != "" ]]; then
            npx playwright test ${{ github.event.inputs.testFile }} --grep "${{ github.event.inputs.grep }}"
          else
            npx playwright test ${{ github.event.inputs.testFile }}
          fi
      - name: Ensure Playwright report exists and extract summary
        if: always()
        id: report-analysis
        run: |
          # Crear directorio de reportes si no existe
          mkdir -p reports/html
          
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          # Verificar si existe el reporte
          if [ ! -f "reports/html/index.html" ]; then
            echo "üìã No se encontr√≥ reporte de Playwright, creando reporte vac√≠o..."
            
            # Crear un reporte HTML b√°sico
            cat > reports/html/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>Playwright Test Report</title>
              <meta charset="utf-8">
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background: #f8f9fa; }
                  .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  .header { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .warning { color: #ff6b35; font-weight: bold; font-size: 18px; }
                  .info { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
                  .info h3 { color: #1976d2; margin-top: 0; }
                  .info ul { margin: 10px 0; }
                  .info li { margin: 5px 0; }
                  .status { background: #ffeb3b; padding: 10px; border-radius: 5px; margin: 15px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üé≠ Playwright Test Report</h1>
                      <p class="warning">‚ö†Ô∏è Reporte Vac√≠o - No se ejecutaron pruebas completamente</p>
                  </div>
                  <div class="status">
                      <strong>Estado:</strong> Las pruebas no se completaron exitosamente o no generaron reporte
                  </div>
                  <div class="info">
                      <h3>üìä Informaci√≥n de la Ejecuci√≥n:</h3>
                      <ul>
                          <li><strong>Archivo de prueba:</strong> ${{ github.event.inputs.testFile }}</li>
                          <li><strong>Filtro (grep):</strong> ${{ github.event.inputs.grep || 'Ninguno' }}</li>
                          <li><strong>URL Base:</strong> ${{ github.event.inputs.baseUrl || 'Por defecto' }}</li>
                          <li><strong>Ejecutado por:</strong> ${{ github.actor }}</li>
                          <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
                          <li><strong>Run ID:</strong> ${{ github.run_id }}</li>
                          <li><strong>Fecha de ejecuci√≥n:</strong> ${TIMESTAMP}</li>
                      </ul>
                  </div>
                  <div class="info">
                      <h3>üîç Posibles Causas:</h3>
                      <ul>
                          <li>Las pruebas fallaron antes de generar el reporte</li>
                          <li>Error en la configuraci√≥n de Playwright</li>
                          <li>Problemas de conectividad o timeout</li>
                          <li>Error en las credenciales de acceso</li>
                      </ul>
                  </div>
              </div>
          </body>
          </html>
          EOF
            
            REPORT_SUMMARY="üìã Reporte vac√≠o generado - Las pruebas no se completaron exitosamente"
            REPORT_STATUS="EMPTY"
            TEST_RESULTS="No se ejecutaron pruebas"
            
            echo "‚úÖ Reporte vac√≠o creado exitosamente"
          else
            echo "‚úÖ Reporte de Playwright encontrado, analizando contenido..."
            
            # Analizar el reporte existente para extraer informaci√≥n
            REPORT_STATUS="COMPLETED"
            
            # Extraer informaci√≥n b√°sica del reporte (ajustar seg√∫n tu formato de reporte)
            if grep -qi "passed" reports/html/index.html && grep -qi "failed" reports/html/index.html; then
              # Intentar extraer estad√≠sticas b√°sicas
              PASSED_TESTS=$(grep -o "passed" reports/html/index.html | wc -l || echo "0")
              FAILED_TESTS=$(grep -o "failed" reports/html/index.html | wc -l || echo "0")
              TEST_RESULTS="Tests ejecutados: ${PASSED_TESTS} passed, ${FAILED_TESTS} failed"
              REPORT_SUMMARY="üìä Reporte completo generado - $TEST_RESULTS"
            else
              TEST_RESULTS="Reporte generado exitosamente"
              REPORT_SUMMARY="üìä Reporte de Playwright generado correctamente"
            fi
          fi
          
          # Crear un resumen en texto plano para incluir en Jira
          cat > report_summary.txt << EOF
          üìã RESUMEN DEL REPORTE DE PLAYWRIGHT
          
          üî∏ Estado: $REPORT_STATUS
          üî∏ Resultado: $TEST_RESULTS
          üî∏ Archivo de prueba: ${{ github.event.inputs.testFile }}
          üî∏ Filtro aplicado: ${{ github.event.inputs.grep || 'Ninguno' }}
          üî∏ URL Base: ${{ github.event.inputs.baseUrl || 'Por defecto' }}
          üî∏ Ejecutado por: ${{ github.actor }}
          üî∏ Branch: ${{ github.ref_name }}
          üî∏ Fecha: ${TIMESTAMP}
          üî∏ Run ID: ${{ github.run_id }}
          
          $(if [ "$REPORT_STATUS" = "EMPTY" ]; then
              echo "‚ö†Ô∏è ATENCI√ìN: Este es un reporte vac√≠o porque las pruebas no se completaron exitosamente."
              echo ""
              echo "Posibles causas:"
              echo "‚Ä¢ Las pruebas fallaron antes de generar el reporte"
              echo "‚Ä¢ Error en la configuraci√≥n de Playwright" 
              echo "‚Ä¢ Problemas de conectividad o timeout"
              echo "‚Ä¢ Error en las credenciales de acceso"
          else
              echo "‚úÖ Las pruebas se ejecutaron y generaron reporte completo."
          fi)
          EOF
          
          # Exportar variables para siguientes steps
          echo "report_summary=$REPORT_SUMMARY" >> $GITHUB_OUTPUT
          echo "report_status=$REPORT_STATUS" >> $GITHUB_OUTPUT
          echo "test_results=$TEST_RESULTS" >> $GITHUB_OUTPUT
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: reports/html/
          retention-days: 30
      - name: Upload report summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-summary
          path: report_summary.txt
          retention-days: 30
      - name: Deploy report to GitHub Pages (if enabled)
        if: always()
        continue-on-error: true
        run: |
          # Solo intentar si GitHub Pages est√° habilitado
          echo "üìÑ Intentando desplegar reporte a GitHub Pages..."
          
          # Crear estructura para GitHub Pages
          mkdir -p gh-pages
          cp -r reports/html/* gh-pages/ 2>/dev/null || true
          
          # Crear archivo index con timestamp √∫nico
          UNIQUE_ID="${{ github.run_id }}-$(date +%s)"
          
          # Renombrar el reporte con ID √∫nico para evitar conflictos
          if [ -f "gh-pages/index.html" ]; then
            mv gh-pages/index.html gh-pages/report-${UNIQUE_ID}.html
            echo "üìÑ Reporte disponible en: report-${UNIQUE_ID}.html"
            echo "pages_report_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/report-${UNIQUE_ID}.html" >> $GITHUB_OUTPUT
          fi
      - name: Send detailed feedback to Jira
        if: always()
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        run: |
          ISSUE_KEY="MT-4"
          
          # Determine test result status
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="PASSED"
          else
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="FAILED"
          fi
          
          # Get current timestamp
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          # Get run URL
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Leer el resumen del reporte
          DETAILED_SUMMARY=""
          if [ -f "report_summary.txt" ]; then
            # Escapar caracteres especiales para JSON y convertir saltos de l√≠nea
            DETAILED_SUMMARY=$(cat report_summary.txt | sed 's/"/\\"/g' | awk '{printf "%s\\n", $0}')
          fi
          
          # Report info from previous step
          REPORT_STATUS="${{ steps.report-analysis.outputs.report_status }}"
          TEST_RESULTS="${{ steps.report-analysis.outputs.test_results }}"
          
          # Create detailed comment body in ADF format with embedded report summary
          COMMENT_BODY=$(cat << EOF
          {
            "body": {
              "type": "doc",
              "version": 1,
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "${STATUS_EMOJI} GitHub Actions Test Execution: ",
                      "marks": [{"type": "strong"}]
                    },
                    {
                      "type": "text",
                      "text": "${STATUS_TEXT}"
                    }
                  ]
                },
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "üìä Test Results: ",
                      "marks": [{"type": "strong"}]
                    },
                    {
                      "type": "text",
                      "text": "${TEST_RESULTS}"
                    }
                  ]
                },
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "üìã Execution Details:",
                      "marks": [{"type": "strong"}]
                    }
                  ]
                },
                {
                  "type": "bulletList",
                  "content": [
                    {
                      "type": "listItem",
                      "content": [
                        {
                          "type": "paragraph",
                          "content": [
                            {
                              "type": "text",
                              "text": "Test File: "
                            },
                            {
                              "type": "text",
                              "text": "${{ github.event.inputs.testFile }}",
                              "marks": [{"type": "code"}]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "listItem",
                      "content": [
                        {
                          "type": "paragraph",
                          "content": [
                            {
                              "type": "text",
                              "text": "Filter (grep): "
                            },
                            {
                              "type": "text",
                              "text": "${{ github.event.inputs.grep || 'None' }}",
                              "marks": [{"type": "code"}]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "listItem",
                      "content": [
                        {
                          "type": "paragraph",
                          "content": [
                            {
                              "type": "text",
                              "text": "Base URL: "
                            },
                            {
                              "type": "text",
                              "text": "${{ github.event.inputs.baseUrl || 'Default' }}",
                              "marks": [{"type": "code"}]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "listItem",
                      "content": [
                        {
                          "type": "paragraph",
                          "content": [
                            {
                              "type": "text",
                              "text": "Executed by: "
                            },
                            {
                              "type": "text",
                              "text": "${{ github.actor }}",
                              "marks": [{"type": "code"}]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "listItem",
                      "content": [
                        {
                          "type": "paragraph",
                          "content": [
                            {
                              "type": "text",
                              "text": "Branch: "
                            },
                            {
                              "type": "text",
                              "text": "${{ github.ref_name }}",
                              "marks": [{"type": "code"}]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "listItem",
                      "content": [
                        {
                          "type": "paragraph",
                          "content": [
                            {
                              "type": "text",
                              "text": "Execution Time: "
                            },
                            {
                              "type": "text",
                              "text": "${TIMESTAMP}",
                              "marks": [{"type": "code"}]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "rule"
                },
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "üìÑ DETAILED REPORT SUMMARY",
                      "marks": [{"type": "strong"}]
                    }
                  ]
                },
                {
                  "type": "codeBlock",
                  "attrs": {"language": "text"},
                  "content": [
                    {
                      "type": "text",
                      "text": "${DETAILED_SUMMARY}"
                    }
                  ]
                },
                {
                  "type": "rule"
                },
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "üîó Links:",
                      "marks": [{"type": "strong"}]
                    }
                  ]
                },
                {
                  "type": "bulletList",
                  "content": [
                    {
                      "type": "listItem",
                      "content": [
                        {
                          "type": "paragraph",
                          "content": [
                            {
                              "type": "text",
                              "text": "GitHub Actions Run",
                              "marks": [{"type": "link", "attrs": {"href": "${RUN_URL}"}}]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "listItem",
                      "content": [
                        {
                          "type": "paragraph",
                          "content": [
                            {
                              "type": "text",
                              "text": "üìã El reporte completo de Playwright est√° incluido en el resumen de arriba"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
          EOF
          )
          
          curl -X POST \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: application/json" \
            --url "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY/comment" \
            -d "$COMMENT_BODY"
