name: Run custom Specific Playwright Tests

on:
  workflow_dispatch:
    inputs:
      testFile:
        description: "Test file to run"
        required: true
        type: choice
        options:
          - tests/vineportal/smoke.tests.spec.js
          - tests/vineportal/admin.tests.spec.js
          - tests/vineportal/flows.tests.spec.js
          - tests/vineportal/massCommunications.tests.spec.js
          - tests/vineportal/projectForms.tests.spec.js
          - tests/vineportal/logInPortal.tests.spec.js
      grep:
        description: "Filter tests by name using --grep (optional)"
        required: false
      baseUrl:
        description: "Base URL to test against"
        required: false
      givenUsername:
        description: "Username for login"
        required: false
      givenPassword:
        description: "Password for login"
        required: false
      givenFilevineUsername:
        description: "Username for Filevine login"
        required: false
      givenFilevinePassword:
        description: "Password for Filevine login"
        required: false

jobs:
  run-playwright-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Install browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        env:
          GIVEN_BASE_URL_PORTAL: ${{ github.event.inputs.baseUrl }}
          GIVENUSERNAME: ${{ github.event.inputs.givenUsername }}
          GIVENPASSWORD: ${{ github.event.inputs.givenPassword }}
          GIVENFILEVINEUSERNAME: ${{ github.event.inputs.givenFilevineUsername }}
          GIVENFILEVINEPASSWORD: ${{ github.event.inputs.givenFilevinePassword }}

        run: |
          if [[ "${{ github.event.inputs.grep }}" != "" ]]; then
            npx playwright test ${{ github.event.inputs.testFile }} --grep "${{ github.event.inputs.grep }}"
          else
            npx playwright test ${{ github.event.inputs.testFile }}
          fi

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: reports/html/
          retention-days: 30
